#ifndef _ARCH_H_DEFINED_
#define _ARCH_H_DEFINED_ 1
static __inline long __syscall0(long n)
{
	unsigned long ret;
	__asm__ __volatile__ ("syscall" : "=a"(ret) : "a"(n) : "rcx", "r11", "memory");
	return ret;
}

static __inline long __syscall1(long n, long a1)
{
	unsigned long ret;
	__asm__ __volatile__ ("syscall" : "=a"(ret) : "a"(n), "D"(a1) : "rcx", "r11", "memory");
	return ret;
}

static __inline long __syscall2(long n, long a1, long a2)
{
	unsigned long ret;
	__asm__ __volatile__ ("syscall" : "=a"(ret) : "a"(n), "D"(a1), "S"(a2)
						  : "rcx", "r11", "memory");
	return ret;
}

static __inline long __syscall3(long n, long a1, long a2, long a3)
{
	unsigned long ret;
	__asm__ __volatile__ ("syscall" : "=a"(ret) : "a"(n), "D"(a1), "S"(a2),
						  "d"(a3) : "rcx", "r11", "memory");
	return ret;
}

static __inline long __syscall4(long n, long a1, long a2, long a3, long a4)
{
	unsigned long ret;
	register long r10 __asm__("r10") = a4;
	__asm__ __volatile__ ("syscall" : "=a"(ret) : "a"(n), "D"(a1), "S"(a2),
						  "d"(a3), "r"(r10): "rcx", "r11", "memory");
	return ret;
}

static __inline long __syscall5(long n, long a1, long a2, long a3, long a4, long a5)
{
	unsigned long ret;
	register long r10 __asm__("r10") = a4;
	register long r8 __asm__("r8") = a5;
	__asm__ __volatile__ ("syscall" : "=a"(ret) : "a"(n), "D"(a1), "S"(a2),
						  "d"(a3), "r"(r10), "r"(r8) : "rcx", "r11", "memory");
	return ret;
}

static __inline long __syscall6(long n, long a1, long a2, long a3, long a4, long a5, long a6)
{
	unsigned long ret;
	register long r10 __asm__("r10") = a4;
	register long r8 __asm__("r8") = a5;
	register long r9 __asm__("r9") = a6;
	__asm__ __volatile__ ("syscall" : "=a"(ret) : "a"(n), "D"(a1), "S"(a2),
						  "d"(a3), "r"(r10), "r"(r8), "r"(r9) : "rcx", "r11", "memory");
	return ret;
}

int errno;

static int mystrlen(const char *str)
{
  int sz = 0;
  while (*str++) sz++;
  return sz;
}

static void myerror(const char *str)
{
    char num[5] = { 0,0,0,0,0 };
    char *ptr = num + sizeof(num) - 2;
    int e;

    __syscall3(__NR_write, 2, (long) str, mystrlen(str));
    __syscall3(__NR_write, 2, (long) ": ", 2);
    *ptr = '0';
    for(e = errno > 0 ? errno : -errno; e > 0; e /= 10)
      *ptr-- = '0' + (e % 10);
    ptr++;
    __syscall3(__NR_write, 2, (long) ptr, mystrlen(ptr));
    __syscall3(__NR_write, 2, (long) "\n", 1);
}

void __stack_chk_fail()
{
  __syscall3(__NR_write, 2, (long) "Stack check failed.", sizeof("Stack check failed.") - 1);
  __syscall1(__NR_exit, 127);
}
#endif
